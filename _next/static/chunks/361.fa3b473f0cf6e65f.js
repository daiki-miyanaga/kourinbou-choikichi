"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[361],{8361:(e,t,i)=>{i.d(t,{default:()=>c});var s=i(1057),a=i(6876);let r=e=>Math.floor(Math.random()*e);function o(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6;return e>=0&&e<i&&t>=0&&t<s}function h(e,t,i,s,a){let r=e[t][i];e[t][i]=e[s][a],e[s][a]=r}function l(e){let t=new Set;for(let i=0;i<e.length;i++){let s=1;for(let a=1;a<=e[i].length;a++)if(a<e[i].length&&0!==e[i][a]&&e[i][a]===e[i][a-1])s++;else{if(s>=3)for(let e=0;e<s;e++)t.add("".concat(i,",").concat(a-1-e));s=1}}for(let i=0;i<e[0].length;i++){let s=1;for(let a=1;a<=e.length;a++)if(a<e.length&&0!==e[a][i]&&e[a][i]===e[a-1][i])s++;else{if(s>=3)for(let e=0;e<s;e++)t.add("".concat(a-1-e,",").concat(i));s=1}}return t}function n(e,t){for(let i of t){let[t,s]=i.split(",").map(Number);e[t][s]=0}}function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,i=e.length,s=e[0].length;for(let a=0;a<s;a++){let s=i-1;for(let t=i-1;t>=0;t--)0!==e[t][a]&&(e[s][a]=e[t][a],s!==t&&(e[t][a]=0),s--);for(let i=s;i>=0;i--)e[i][a]=r(t)+1}}class c extends s.Scene{preload(){this.load.image("item-gyusuji",(0,a.L)("/images/items/gyuusuji.png")),this.load.image("item-edamame",(0,a.L)("/images/items/edamame.png")),this.load.image("item-potatosalad",(0,a.L)("/images/items/potatosalad.png")),this.load.image("item-sausage",(0,a.L)("/images/items/sausage.png")),this.load.image("item-bomb",(0,a.L)("/images/items/bomb.svg")),this.load.image("bg-choikichi",(0,a.L)("/images/backgrounds/choikichi.jpg")),this.load.image("mama-left",(0,a.L)("/images/characters/mama/mama-left.png")),this.load.audio("bgm",[(0,a.L)("/bgm-se/bgm.mp3")])}keyFor(e){switch(e){case 1:return"item-gyusuji";case 2:default:return"item-edamame";case 3:return"item-potatosalad";case 4:return"item-sausage";case 99:return"item-bomb"}}create(){this.cameras.main.setBackgroundColor("#0b0f19");let e=this.cameras.main;this.add.image(0,0,"bg-choikichi").setOrigin(0,0).setDisplaySize(e.width,e.height).setDepth(-10),this.score=0,this.timeLeft=60,this.comboLevel=0,this.feverGauge=0,this.feverActive=!1,this.feverTimeLeft=0,this.board=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,s=Array.from({length:e},()=>Array(t).fill(0));for(let a=0;a<e;a++)for(let e=0;e<t;e++){let t;do t=r(i)+1;while(e>=2&&s[a][e-1]===t&&s[a][e-2]===t||a>=2&&s[a-1][e]===t&&s[a-2][e]===t);s[a][e]=t}return s}(6,6,4),this.originX=(this.cameras.main.width-384)/2,this.originY=8,this.createGrid(),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointerup",this.onPointerUp,this),this.uiScore=this.add.text(16,8,"SCORE 0",{fontFamily:"monospace",fontSize:"18px",color:"#e6e9ef"}),this.uiTime=this.add.text(300,8,"TIME 60",{fontFamily:"monospace",fontSize:"18px",color:"#e6e9ef"}),this.createFeverUI();let t="v".concat(Date.now().toString(36));this.add.text(this.cameras.main.width-8,this.cameras.main.height-8,t,{fontFamily:"monospace",fontSize:"10px",color:"#666666"}).setOrigin(1,1).setAlpha(.7),this.startTimer();let i=()=>{this.bgm||(this.bgm=this.sound.add("bgm",{loop:!0,volume:.5}),this.bgm.play())};this.sound.locked?this.input.once("pointerdown",i):i()}createFeverUI(){let e=this.cameras.main;this.feverOverlay=this.add.rectangle(e.width/2,e.height/2,e.width,e.height,0xffa552,0).setScrollFactor(0).setDepth(-5),this.feverGaugeGraphics=this.add.graphics({x:16,y:40}).setScrollFactor(0),this.feverLabel=this.add.text(16,52,"暖簾フィーバー 0%",{fontFamily:"monospace",fontSize:"16px",color:"#ffd166"}).setScrollFactor(0),this.updateFeverUI()}updateFeverUI(){if(!this.feverGaugeGraphics||!this.feverLabel)return;let e=this.feverActive?this.feverTimeLeft/10*100:this.feverGauge,t=s.Math.Clamp(e,0,100);if(this.feverGaugeGraphics.clear(),this.feverGaugeGraphics.fillStyle(0xffffff,.15),this.feverGaugeGraphics.fillRoundedRect(0,0,220,14,6),t>0){let e=this.feverActive?0xff6f61:0xffd166;this.feverGaugeGraphics.fillStyle(e,this.feverActive?.9:.8),this.feverGaugeGraphics.fillRoundedRect(2,2,t/100*216,10,4)}if(this.feverActive){let e=Math.max(0,this.feverTimeLeft).toFixed(1);this.feverLabel.setText("暖簾フィーバー 残り".concat(e,"秒")),this.feverLabel.setColor("#ffb3a7")}else this.feverLabel.setText("暖簾フィーバー ".concat(Math.round(t),"%")),this.feverLabel.setColor("#ffd166")}addFeverEnergy(e){if(!(e<=0)){if(this.feverActive){let t=Math.min(2,e/60);this.extendFever(t);return}this.feverGauge=s.Math.Clamp(this.feverGauge+e,0,100),this.feverGauge>=100&&this.activateFever(),this.updateFeverUI()}}activateFever(){var e;this.feverActive||(this.feverActive=!0,this.feverGauge=100,this.feverTimeLeft=10,this.updateFeverUI(),this.playFeverChime(),this.feverOverlay&&this.tweens.add({targets:this.feverOverlay,alpha:.35,duration:250,ease:"Sine.easeOut"}),this.sound.setRate(1.12),null==(e=this.feverTimer)||e.remove(),this.feverTimer=this.time.addEvent({delay:100,loop:!0,callback:()=>{this.feverTimeLeft=Math.max(0,this.feverTimeLeft-.1),this.feverTimeLeft<=0?this.endFever():this.updateFeverUI()}}))}extendFever(e){this.feverActive&&!(e<=0)&&(this.feverTimeLeft=s.Math.Clamp(this.feverTimeLeft+e,0,12),this.updateFeverUI())}endFever(){var e;this.feverActive&&(this.feverActive=!1,this.feverGauge=0,null==(e=this.feverTimer)||e.remove(),this.feverTimer=void 0,this.feverOverlay&&this.tweens.add({targets:this.feverOverlay,alpha:0,duration:250,ease:"Sine.easeOut"}),this.sound.setRate(1),this.updateFeverUI())}createGrid(){for(let e=0;e<6;e++){this.tiles[e]=[];for(let t=0;t<6;t++){let i=this.board[e][t],a=this.originX+64*t+32,r=this.originY+64*e+32,o=this.add.image(a,r,this.keyFor(i));o.setDisplaySize(60,60),o.setInteractive({useHandCursor:!0}),o.setAlpha(1),o.setBlendMode(s.BlendModes.NORMAL),o.r=e,o.c=t,o.v=i,this.tiles[e][t]=o}}}boardToWorld(e,t){return{x:this.originX+64*t+32,y:this.originY+64*e+32}}pickCell(e){let t=e.x-this.originX,i=e.y-this.originY,s=Math.floor(t/64),a=Math.floor(i/64);return a<0||a>=6||s<0||s>=6?null:{r:a,c:s}}onPointerDown(e){let t=this.pickCell(e);t&&(this.selected=t,this.pulse(t.r,t.c,!0))}onPointerUp(e){var t,i;if(!this.selected||this.timeLeft<=0)return;let s=this.selected;this.pulse(s.r,s.c,!1),this.selected=null;let a=this.pickCell(e);a&&(t=s.r,i=s.c,Math.abs(t-a.r)+Math.abs(i-a.c)===1)&&this.trySwap(s,a)}pulse(e,t,i){let s=this.tiles[e][t];if(!s||!s.scene)return;this.tweens.killTweensOf(s);let{x:a,y:r}=this.boardToWorld(e,t);s.x=a,s.y=r,s.setDisplaySize(60,60),s.clearTint(),i&&(this.tweens.add({targets:s,y:r-4,duration:100,ease:"Sine.easeOut"}),s.setTint(0xffffaa))}dispatchMamaEmotion(e){let t=new CustomEvent("mamaEmotion",{detail:e});window.dispatchEvent(t)}dispatchMasakiPopup(){let e=new CustomEvent("masakiPopup");window.dispatchEvent(e)}getAudioContext(){let e=this.sound;if("context"in e){let t=e.context;if(t)return t}return null}playTone(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.2;if(this.sound.locked)return;let s=this.getAudioContext();if(!s)return;let a=s.currentTime,r=s.createOscillator(),o=s.createGain();r.type="sine",r.frequency.setValueAtTime(e,a),o.gain.setValueAtTime(1e-4,a),o.gain.linearRampToValueAtTime(i,a+.02),o.gain.exponentialRampToValueAtTime(1e-4,a+t),r.connect(o),o.connect(s.destination),r.start(a),r.stop(a+t+.05)}playLandingBeat(){this.sound.locked||(this.playTone(220,.12,.18),this.time.delayedCall(90,()=>this.playTone(320,.08,.12)))}playFeverChime(){this.sound.locked||(this.playTone(660,.25,.12),this.time.delayedCall(160,()=>this.playTone(880,.2,.1)))}async trySwap(e,t){if(99===this.board[e.r][e.c])return void await this.explodeBombAt(e.r,e.c);if(99===this.board[t.r][t.c])return void await this.explodeBombAt(t.r,t.c);if(await this.animateSwap(e,t),h(this.board,e.r,e.c,t.r,t.c),0===l(this.board).size){this.dispatchMamaEmotion("sad"),await this.animateSwap(e,t),h(this.board,e.r,e.c,t.r,t.c);return}await this.resolveMatches()}async animateSwap(e,t){let i=this.tiles[e.r][e.c],s=this.tiles[t.r][t.c];this.tiles[e.r][e.c]=s,this.tiles[t.r][t.c]=i;let a=this.boardToWorld(e.r,e.c),r=this.boardToWorld(t.r,t.c);return new Promise(e=>{this.tweens.add({targets:i,x:r.x,y:r.y,duration:120,ease:"Sine.easeInOut"}),this.tweens.add({targets:s,x:a.x,y:a.y,duration:120,ease:"Sine.easeInOut",onComplete:()=>e()})})}async resolveMatches(){for(this.selected&&(this.pulse(this.selected.r,this.selected.c,!1),this.selected=null),this.comboLevel=0;;){let e=l(this.board);if(0===e.size)break;this.dispatchMamaEmotion("smile"),this.comboLevel>0&&this.dispatchMamaEmotion("surprise");let t=function(e){let t=[];for(let i=0;i<e.length;i++){let s=1;for(let a=1;a<=e[i].length;a++)a<e[i].length&&0!==e[i][a]&&e[i][a]===e[i][a-1]?s++:(s>=3&&t.push(s),s=1)}for(let i=0;i<e[0].length;i++){let s=1;for(let a=1;a<=e.length;a++)a<e.length&&0!==e[a][i]&&e[a][i]===e[a-1][i]?s++:(s>=3&&t.push(s),s=1)}return t}(this.board),i=function(e){let t=0;for(let i of e)t+=100*i,4===i&&(t+=500);return t}(t),s=[1,1.2,1.5,2,3,5],a=Math.round(i*s[Math.min(this.comboLevel,s.length-1)]*(this.feverActive?2:1));this.score+=a,this.uiScore&&this.uiScore.setText("SCORE ".concat(this.score));let r=t.some(e=>e>=5);if(r){this.dispatchMasakiPopup();let e=function(e,t){let i=[],s=0;for(let a=0;a<e.length;a++){let r=1,o=0;for(let h=1;h<=e[a].length;h++)if(h<e[a].length&&0!==e[a][h]&&e[a][h]===e[a][h-1])r++;else{if(r>=5&&s<t.length&&t[s]>=5){let e=Math.floor(o+r/2);i.push({r:a,c:e})}r>=3&&s++,o=h,r=1}}for(let a=0;a<e[0].length;a++){let r=1,o=0;for(let h=1;h<=e.length;h++)if(h<e.length&&0!==e[h][a]&&e[h][a]===e[h-1][a])r++;else{if(r>=5&&s<t.length&&t[s]>=5){let e=Math.floor(o+r/2);i.push({r:e,c:a})}r>=3&&s++,o=h,r=1}}return i}(this.board,t);!function(e,t){t.forEach(t=>{let{r:i,c:s}=t;o(i,s)&&0===e[i][s]&&(e[i][s]=99)})}(this.board,e)}let h=t.reduce((e,t)=>e+8*t,0),c=12*this.comboLevel;r&&this.addFeverEnergy(35),this.addFeverEnergy(h+c),await new Promise(t=>{let i=[];e.forEach(e=>{let[t,s]=e.split(",").map(Number),a=this.tiles[t][s];i.push(a)}),this.tweens.add({targets:i,alpha:0,duration:120,onComplete:()=>t()})}),n(this.board,e),e.forEach(e=>{let[t,i]=e.split(",").map(Number);this.tiles[t][i].destroy(),this.tiles[t][i]=null}),d(this.board,4),await this.animateCollapse(),this.comboLevel++}}startTimer(){var e;this.timeLeft=60,this.uiTime&&this.uiTime.setText("TIME ".concat(this.timeLeft)),null==(e=this.ticking)||e.remove(!1),this.ticking=this.time.addEvent({delay:1e3,loop:!0,callback:()=>{this.timeLeft--,this.uiTime&&this.uiTime.setText("TIME ".concat(Math.max(0,this.timeLeft))),this.timeLeft<=0&&this.endGame()}})}endGame(){var e;this.dispatchMamaEmotion("gameover"),this.score>=8e3&&this.dispatchMamaEmotion("happy"),this.endFever(),null==(e=this.ticking)||e.remove(!1),this.input.off("pointerdown",this.onPointerDown,this),this.input.off("pointerup",this.onPointerUp,this);let t=(this.cameras.main.width-360)/2,i=(this.cameras.main.height-200)/2,s=this.add.rectangle(t,i,360,200,0,.7).setOrigin(0).setStrokeStyle(2,0xffffff,.5),a=this.add.text(t+16,i+16,"RESULT",{fontFamily:"monospace",fontSize:"20px",color:"#e6e9ef"}),r=this.add.text(t+16,i+56,"Score: ".concat(this.score),{fontFamily:"monospace",fontSize:"18px",color:"#e6e9ef"}),o=this.commentForScore(this.score),h=this.add.text(t+16,i+88,o,{fontFamily:"sans-serif",fontSize:"16px",color:"#ffd166",wordWrap:{width:328}}),l=this.add.text(t+360-120,i+200-36,"[ Restart ]",{fontFamily:"monospace",fontSize:"18px",color:"#06d6a0"}).setInteractive({useHandCursor:!0}).on("pointerup",()=>{s.destroy(),a.destroy(),r.destroy(),h.destroy(),l.destroy(),this.scene.restart()})}commentForScore(e){return e>=15e3?"盛り上がっとるぞいね！":e>=8e3?"やるじぃ、ほんに！":e>=3e3?"うまいげんて！":"また来まっし〜"}async explodeBombAt(e,t){this.createExplosionEffect(e,t);let i=function(e,t,i){let s=new Set;s.add("".concat(t,",").concat(i));for(let a=-1;a<=1;a++)for(let r=-1;r<=1;r++){let h=t+a,l=i+r;o(h,l)&&0!==e[h][l]&&s.add("".concat(h,",").concat(l))}return s}(this.board,e,t),s=200*i.size;this.score+=s,this.uiScore&&this.uiScore.setText("SCORE ".concat(this.score)),await new Promise(e=>{let t=[];i.forEach(e=>{let[i,s]=e.split(",").map(Number),a=this.tiles[i][s];a&&t.push(a)}),this.tweens.add({targets:t,alpha:0,scaleX:1.5,scaleY:1.5,duration:300,ease:"Back.easeIn",onComplete:()=>e()})}),n(this.board,i),i.forEach(e=>{let[t,i]=e.split(",").map(Number),s=this.tiles[t][i];s&&(s.destroy(),this.tiles[t][i]=null)}),d(this.board,4),await this.animateCollapse(),await this.resolveMatches()}createExplosionEffect(e,t){let{x:i,y:s}=this.boardToWorld(e,t),a=this.add.circle(i,s,0,0xff6600,.8);this.tweens.add({targets:a,radius:96,alpha:0,duration:400,ease:"Quad.easeOut",onComplete:()=>a.destroy()});for(let e=0;e<8;e++){let t=e/8*Math.PI*2,a=this.add.circle(i,s,3,0xffaa00),r=i+50*Math.cos(t),o=s+50*Math.sin(t);this.tweens.add({targets:a,x:r,y:o,alpha:0,duration:300,ease:"Quad.easeOut",onComplete:()=>a.destroy()})}}async animateCollapse(){for(let e=0;e<6;e++)for(let t=0;t<6;t++){let i=this.tiles[e][t];if(i&&i.scene){this.tweens.killTweensOf(i);let{x:s,y:a}=this.boardToWorld(e,t);i.x=s,i.y=a,i.setDisplaySize(60,60),i.clearTint()}}let e=(e,t)=>{let i=this.board[e][t],{x:a,y:r}=this.boardToWorld(e,t),o=this.add.image(a,r-384,this.keyFor(i));return o.setDisplaySize(60,60),o.setInteractive({useHandCursor:!0}),o.setAlpha(0),o.setBlendMode(s.BlendModes.NORMAL),o.r=e,o.c=t,o.v=i,this.tiles[e][t]=o,o},t=this.feverActive?100:160;for(let i=0;i<6;i++)for(let s=0;s<6;s++){let a=this.tiles[i][s];if(a&&a.texture){let e=this.board[i][s];a.v!==e&&(a.setTexture(this.keyFor(e)),a.setDisplaySize(60,60),a.v=e)}else a=e(i,s);let{x:r,y:o}=this.boardToWorld(i,s);this.tweens.add({targets:a,x:r,y:o,alpha:1,duration:t,ease:"Quad.easeIn",onComplete:()=>{this.tweens.add({targets:a,y:o+6,duration:90,ease:"Sine.easeOut",yoyo:!0})}})}await new Promise(e=>this.time.delayedCall(t+15,()=>e())),this.playLandingBeat()}constructor(){super("MainScene"),this.tiles=[],this.originX=0,this.originY=0,this.selected=null,this.score=0,this.timeLeft=60,this.comboLevel=0,this.feverGauge=0,this.feverActive=!1,this.feverTimeLeft=0}}}}]);