"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[361],{8361:(t,e,i)=>{i.d(e,{default:()=>h});var s=i(1057),a=i(6876);let o=t=>Math.floor(Math.random()*t);function r(t,e,i,s,a){let o=t[e][i];t[e][i]=t[s][a],t[s][a]=o}function l(t){let e=new Set;for(let i=0;i<t.length;i++){let s=1;for(let a=1;a<=t[i].length;a++)if(a<t[i].length&&0!==t[i][a]&&t[i][a]===t[i][a-1])s++;else{if(s>=3)for(let t=0;t<s;t++)e.add("".concat(i,",").concat(a-1-t));s=1}}for(let i=0;i<t[0].length;i++){let s=1;for(let a=1;a<=t.length;a++)if(a<t.length&&0!==t[a][i]&&t[a][i]===t[a-1][i])s++;else{if(s>=3)for(let t=0;t<s;t++)e.add("".concat(a-1-t,",").concat(i));s=1}}return e}class h extends s.Scene{preload(){this.load.image("item-gyusuji",(0,a.L)("/images/items/gyuusuji.svg")),this.load.image("item-edamame",(0,a.L)("/images/items/edamame.svg")),this.load.image("item-potatosalad",(0,a.L)("/images/items/potatosalad.svg")),this.load.image("item-sausage",(0,a.L)("/images/items/sausage.svg")),this.load.image("bg-choikichi",(0,a.L)("/images/backgrounds/choikichi.jpg")),this.load.image("mama-left",(0,a.L)("/images/characters/mama/mama-left.png")),this.load.audio("bgm",[(0,a.L)("/bgm-se/bgm.mp3")])}keyFor(t){switch(t){case 1:return"item-gyusuji";case 2:default:return"item-edamame";case 3:return"item-potatosalad";case 4:return"item-sausage"}}create(){this.cameras.main.setBackgroundColor("#0b0f19");let t=this.cameras.main;this.add.image(0,0,"bg-choikichi").setOrigin(0,0).setDisplaySize(60,60).setDepth(-10),this.board=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,s=Array.from({length:t},()=>Array(e).fill(0));for(let a=0;a<t;a++)for(let t=0;t<e;t++){let e;do e=o(i)+1;while(t>=2&&s[a][t-1]===e&&s[a][t-2]===e||a>=2&&s[a-1][t]===e&&s[a-2][t]===e);s[a][t]=e}return s}(6,6,4),this.originX=(this.cameras.main.width-384)/2,this.originY=8,this.createGrid(),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointerup",this.onPointerUp,this),this.uiScore=this.add.text(16,8,"SCORE 0",{fontFamily:"monospace",fontSize:"18px",color:"#e6e9ef"}),this.uiTime=this.add.text(300,8,"TIME 60",{fontFamily:"monospace",fontSize:"18px",color:"#e6e9ef"});let e="v".concat(Date.now().toString(36));this.add.text(this.cameras.main.width-8,this.cameras.main.height-8,e,{fontFamily:"monospace",fontSize:"10px",color:"#666666"}).setOrigin(1,1).setAlpha(.7),this.startTimer();let i=()=>{this.bgm||(this.bgm=this.sound.add("bgm",{loop:!0,volume:.5}),this.bgm.play())};this.sound.locked?this.input.once("pointerdown",i):i()}createGrid(){for(let t=0;t<6;t++){this.tiles[t]=[];for(let e=0;e<6;e++){let i=this.board[t][e],s=this.originX+64*e+32,a=this.originY+64*t+32,o=this.add.image(s,a,this.keyFor(i));o.setDisplaySize(60,60),o.setInteractive({useHandCursor:!0}),o.r=t,o.c=e,o.v=i,this.tiles[t][e]=o}}}boardToWorld(t,e){return{x:this.originX+64*e+32,y:this.originY+64*t+32}}pickCell(t){let e=t.x-this.originX,i=t.y-this.originY,s=Math.floor(e/64),a=Math.floor(i/64);return a<0||a>=6||s<0||s>=6?null:{r:a,c:s}}onPointerDown(t){let e=this.pickCell(t);e&&(this.selected=e,this.pulse(e.r,e.c,!0))}onPointerUp(t){var e,i;if(!this.selected||this.timeLeft<=0)return;let s=this.selected;this.pulse(s.r,s.c,!1),this.selected=null;let a=this.pickCell(t);a&&(e=s.r,i=s.c,Math.abs(e-a.r)+Math.abs(i-a.c)===1)&&this.trySwap(s,a)}pulse(t,e,i){let s=this.tiles[t][e],{y:a}=this.boardToWorld(t,e);s.setY(a),s.setScale(1),this.tweens.killTweensOf(s),i?(this.tweens.add({targets:s,y:a-8,scaleX:1.1,scaleY:1.1,duration:150,ease:"Back.easeOut"}),s.setTint(0xffffaa)):(this.tweens.add({targets:s,y:a,scaleX:1,scaleY:1,duration:150,ease:"Back.easeIn",onComplete:()=>{s.setScale(1)}}),s.clearTint())}dispatchMamaEmotion(t){let e=new CustomEvent("mamaEmotion",{detail:t});window.dispatchEvent(e)}async trySwap(t,e){if(await this.animateSwap(t,e),r(this.board,t.r,t.c,e.r,e.c),0===l(this.board).size){this.dispatchMamaEmotion("sad"),await this.animateSwap(t,e),r(this.board,t.r,t.c,e.r,e.c);return}await this.resolveMatches()}async animateSwap(t,e){let i=this.tiles[t.r][t.c],s=this.tiles[e.r][e.c];this.tiles[t.r][t.c]=s,this.tiles[e.r][e.c]=i;let a=this.boardToWorld(t.r,t.c),o=this.boardToWorld(e.r,e.c);return new Promise(t=>{this.tweens.add({targets:i,x:o.x,y:o.y,duration:120,ease:"Sine.easeInOut"}),this.tweens.add({targets:s,x:a.x,y:a.y,duration:120,ease:"Sine.easeInOut",onComplete:()=>t()})})}async resolveMatches(){for(this.selected&&(this.pulse(this.selected.r,this.selected.c,!1),this.selected=null),this.comboLevel=0;;){let e=l(this.board);if(0===e.size)break;this.dispatchMamaEmotion("smile"),this.comboLevel>0&&this.dispatchMamaEmotion("surprise");let i=function(t){let e=0;for(let i of t)e+=100*i,4===i&&(e+=500);return e}(function(t){let e=[];for(let i=0;i<t.length;i++){let s=1;for(let a=1;a<=t[i].length;a++)a<t[i].length&&0!==t[i][a]&&t[i][a]===t[i][a-1]?s++:(s>=3&&e.push(s),s=1)}for(let i=0;i<t[0].length;i++){let s=1;for(let a=1;a<=t.length;a++)a<t.length&&0!==t[a][i]&&t[a][i]===t[a-1][i]?s++:(s>=3&&e.push(s),s=1)}return e}(this.board)),s=[1,1.2,1.5,2,3,5],a=Math.round(i*s[Math.min(this.comboLevel,s.length-1)]);this.score+=a,this.uiScore&&this.uiScore.setText("SCORE ".concat(this.score)),await new Promise(t=>{let i=[];e.forEach(t=>{let[e,s]=t.split(",").map(Number),a=this.tiles[e][s];i.push(a)}),this.tweens.add({targets:i,alpha:0,duration:120,onComplete:()=>t()})});var t=this.board;for(let i of e){let[e,s]=i.split(",").map(Number);t[e][s]=0}e.forEach(t=>{let[e,i]=t.split(",").map(Number);this.tiles[e][i].destroy(),this.tiles[e][i]=null}),function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,i=t.length,s=t[0].length;for(let a=0;a<s;a++){let s=i-1;for(let e=i-1;e>=0;e--)0!==t[e][a]&&(t[s][a]=t[e][a],s!==e&&(t[e][a]=0),s--);for(let i=s;i>=0;i--)t[i][a]=o(e)+1}}(this.board,4),await this.animateCollapse(),this.comboLevel++}}startTimer(){var t;this.timeLeft=60,this.uiTime&&this.uiTime.setText("TIME ".concat(this.timeLeft)),null==(t=this.ticking)||t.remove(!1),this.ticking=this.time.addEvent({delay:1e3,loop:!0,callback:()=>{this.timeLeft--,this.uiTime&&this.uiTime.setText("TIME ".concat(Math.max(0,this.timeLeft))),this.timeLeft<=0&&this.endGame()}})}endGame(){var t;this.dispatchMamaEmotion("gameover"),this.score>=8e3&&this.dispatchMamaEmotion("happy"),null==(t=this.ticking)||t.remove(!1),this.input.off("pointerdown",this.onPointerDown,this),this.input.off("pointerup",this.onPointerUp,this);let e=(this.cameras.main.width-360)/2,i=(this.cameras.main.height-200)/2,s=this.add.rectangle(e,i,360,200,0,.7).setOrigin(0).setStrokeStyle(2,0xffffff,.5),a=this.add.text(e+16,i+16,"RESULT",{fontFamily:"monospace",fontSize:"20px",color:"#e6e9ef"}),o=this.add.text(e+16,i+56,"Score: ".concat(this.score),{fontFamily:"monospace",fontSize:"18px",color:"#e6e9ef"}),r=this.commentForScore(this.score),l=this.add.text(e+16,i+88,r,{fontFamily:"sans-serif",fontSize:"16px",color:"#ffd166",wordWrap:{width:328}}),h=this.add.text(e+360-120,i+200-36,"[ Restart ]",{fontFamily:"monospace",fontSize:"18px",color:"#06d6a0"}).setInteractive({useHandCursor:!0}).on("pointerup",()=>{s.destroy(),a.destroy(),o.destroy(),l.destroy(),h.destroy(),this.scene.restart()})}commentForScore(t){return t>=15e3?"盛り上がっとるぞいね！":t>=8e3?"やるじぃ、ほんに！":t>=3e3?"うまいげんて！":"また来まっし〜"}async animateCollapse(){for(let t=0;t<6;t++)for(let e=0;e<6;e++){let i=this.tiles[t][e];i&&(this.tweens.killTweensOf(i),i.setScale(1),i.clearTint())}let t=(t,e)=>{let i=this.board[t][e],{x:s,y:a}=this.boardToWorld(t,e),o=this.add.image(s,a-384,this.keyFor(i));return o.setDisplaySize(60,60),o.setInteractive({useHandCursor:!0}),o.alpha=0,o.r=t,o.c=e,o.v=i,this.tiles[t][e]=o,o},e=[];for(let i=0;i<6;i++)for(let s=0;s<6;s++){let a=this.tiles[i][s];if(a&&a.texture){let t=this.board[i][s];a.v!==t&&(a.setTexture(this.keyFor(t)),a.setDisplaySize(60,60),a.v=t)}else a=t(i,s);let{x:o,y:r}=this.boardToWorld(i,s);e.push(this.tweens.add({targets:a,x:o,y:r,alpha:1,duration:160,ease:"Sine.easeIn"}))}await new Promise(t=>this.time.delayedCall(170,()=>t()))}constructor(){super("MainScene"),this.tiles=[],this.originX=0,this.originY=0,this.selected=null,this.score=0,this.timeLeft=60,this.comboLevel=0}}}}]);